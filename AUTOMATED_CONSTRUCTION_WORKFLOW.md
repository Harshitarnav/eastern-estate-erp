# Automated Construction-Payment Workflow

## Overview

This document describes the complete automated workflow for construction progress tracking, milestone detection, and demand draft generation.

## Ideal Flow (Now Implemented)

```
1. Construction Progress Logged
         ↓
2. Flat Module Updated (stage & percentage)
         ↓
3. Check if Flat is Sold (has active payment plan)
         ↓ (yes)
4. Check Payment Milestones
         ↓
5. Milestone Reached? (construction phase & progress match)
         ↓ (yes)
6. Update Milestone Status to TRIGGERED
         ↓
7. Auto-Generate Demand Draft (DRAFT status, requiresReview=true)
         ↓
8. Review/Edit Draft
         ↓
9. Export Draft (formatted HTML for PDF)
         ↓
10. Approve & Send to Customer
```

## Implementation Details

### 1. Database Changes

#### Added to `flats` table:
```sql
-- New columns for construction tracking
construction_stage VARCHAR(50)        -- Current phase: FOUNDATION, STRUCTURE, MEP, FINISHING, HANDOVER
construction_progress DECIMAL(5,2)    -- Overall completion percentage (0-100)
last_construction_update TIMESTAMP     -- When last updated
```

**Migration File**: `backend/src/database/migrations/002_add_flat_construction_tracking.sql`

### 2. Backend Services

#### A. ConstructionWorkflowService
**Location**: `backend/src/modules/construction/services/construction-workflow.service.ts`

**Key Method**: `processConstructionUpdate(flatId, phase, phaseProgress, overallProgress)`

**Flow**:
1. Updates flat with current construction status
2. Checks if flat has active payment plan
3. For each pending milestone:
   - Checks if construction phase matches
   - Checks if progress percentage reached
   - If yes: Updates milestone status to TRIGGERED
   - Auto-generates demand draft

**Features**:
- ✅ Automatic flat status update
- ✅ Milestone detection based on construction phase
- ✅ Auto-generated demand drafts with formatted content
- ✅ Metadata tracking (milestone info, due dates, etc.)
- ✅ Error handling (doesn't fail if workflow errors occur)

#### B. FlatProgressSimpleController Updated
**Location**: `backend/src/modules/construction/controllers/flat-progress-simple.controller.ts`

**Enhancement**:
```typescript
const savedProgress = await this.flatProgressService.create(createDto);

// Trigger automated workflow
await this.workflowService.processConstructionUpdate(
  dto.flatId,
  dto.phase,
  dto.phaseProgress || 0,
  dto.overallProgress || 0,
);
```

**Result**: Every time construction progress is logged, the entire workflow is automatically triggered.

### 3. Demand Draft Management

#### Updated Features:

**A. Auto-Generation**:
- Demand drafts auto-generated when milestones reached
- Status: DRAFT (editable)
- Requires Review: TRUE
- Content: Formatted letter with all details

**B. Edit**:
- **Endpoint**: `PUT /demand-drafts/:id`
- **Usage**: Update content, amount, or any field before sending
- Frontend can modify the draft before approval

**C. Export**:
- **Endpoint**: `GET /demand-drafts/:id/export`
- **Returns**: Formatted HTML ready for PDF conversion
- **Features**:
  - Professional styling
  - Complete payment details
  - Company header/footer
  - Due date and amount highlighted

**D. Workflow States**:
1. **DRAFT** - Auto-generated, editable, requires review
2. **READY** - Reviewed and approved, ready to send
3. **SENT** - Delivered to customer
4. **FAILED** - Export or send failed

### 4. Complete Workflow Example

#### Step 1: Log Construction Progress
```bash
POST /construction/flat-progress
{
  "flatId": "flat-123",
  "phase": "FOUNDATION",
  "phaseProgress": 100,
  "overallProgress": 20,
  "status": "COMPLETED",
  "notes": "Foundation work completed"
}
```

#### Step 2: Automatic Updates (Behind the Scenes)

**A. Flat Table Updated**:
```sql
UPDATE flats SET
  construction_stage = 'FOUNDATION',
  construction_progress = 20,
  last_construction_update = NOW()
WHERE id = 'flat-123';
```

**B. Payment Plan Checked**:
```typescript
// System finds active payment plan for flat
// Checks all pending milestones
// Milestone 1: "Foundation Complete" - FOUNDATION @ 100%
//   ✓ Phase matches: FOUNDATION
//   ✓ Progress reached: 100%
//   → Status updated to TRIGGERED
```

**C. Demand Draft Generated**:
```typescript
DemandDraft {
  id: "dd-456",
  flatId: "flat-123",
  customerId: "cust-789",
  milestoneId: "1",
  amount: 500000,
  status: "DRAFT",
  requiresReview: true,
  content: "Dear Customer, construction milestone reached...",
  metadata: {
    title: "Payment Demand - Foundation Complete",
    dueDate: "2026-03-18",
    milestoneName: "Foundation Complete",
    constructionPhase: "FOUNDATION",
    autoGenerated: true
  }
}
```

#### Step 3: Review & Edit (Manual)
```bash
# View the draft
GET /demand-drafts/dd-456

# Edit if needed
PUT /demand-drafts/dd-456
{
  "content": "Updated payment demand letter...",
  "amount": 525000
}

# Preview
GET /demand-drafts/dd-456/preview
```

#### Step 4: Export (Manual)
```bash
GET /demand-drafts/dd-456/export
# Returns formatted HTML for PDF conversion
```

#### Step 5: Approve & Send (Manual)
```bash
# Approve
PUT /demand-drafts/dd-456/approve
# Status changes to READY

# Send
POST /demand-drafts/dd-456/send
# Status changes to SENT
```

## Frontend Integration

### Construction Progress Simple Page
**Location**: `frontend/src/app/(dashboard)/construction-progress-simple/page.tsx`

**Usage**:
1. Select Property → Tower → Flat
2. Choose Construction Phase
3. Enter Progress Percentage
4. Add Notes
5. Click "Save Progress"

**Result**: Entire backend workflow triggered automatically!

### Construction Milestones Page
**Location**: `frontend/src/app/(dashboard)/construction-milestones/page.tsx`

**Features**:
- **Not Started Tab**: Shows all pending milestones
- **In Progress Tab**: Shows milestones with partial construction progress
- **Ready to Trigger Tab**: Shows milestones that reached required progress (green)
- **Awaiting Payment Tab**: Shows triggered milestones (TRIGGERED status)
- **Completed Tab**: Shows paid milestones
- **Demand Drafts Tab**: Shows drafts pending review or ready to send

**Real-time Updates**:
- Progress bars show actual construction progress
- Color-coded indicators (green=ready, yellow=in progress, gray=not started)
- Links to log progress, view flat details

### Payment Plan Details Page
**Location**: `frontend/src/app/(dashboard)/payment-plans/[id]/page.tsx`

**Shows**:
- All milestones with construction linkage
- Payment status per milestone
- Progress tracking
- Quick links to construction pages

## Data Flow Diagram

```
[User Logs Progress]
         ↓
[POST /construction/flat-progress]
         ↓
[FlatProgressSimpleController]
         ↓ (saves progress)
[construction_flat_progress table]
         ↓ (triggers)
[ConstructionWorkflowService.processConstructionUpdate()]
         ├─→ [Updates flats table]
         │   (construction_stage, construction_progress, last_construction_update)
         │
         ├─→ [Finds FlatPaymentPlan]
         │   (checks if flat is sold)
         │
         ├─→ [Checks Milestones]
         │   (matches phase & progress)
         │
         └─→ [Generates DemandDraft]
             (auto-created, requires review)
                  ↓
         [demand_drafts table]
                  ↓
         [Construction Milestones Page]
         (shows in "Not Started" or other tabs)
                  ↓
         [User Reviews/Edits]
                  ↓
         [Exports HTML/PDF]
                  ↓
         [Approves & Sends]
```

## Key Features

### ✅ Fully Automated
- No manual milestone checking
- No manual demand draft creation
- Updates happen in real-time

### ✅ Transparent
- All steps logged
- Audit trail maintained
- Flat status always current

### ✅ Flexible
- Drafts can be edited before sending
- Manual override available
- Custom content supported

### ✅ Safe
- Errors don't stop progress logging
- Reviews required before sending
- Duplicate prevention built-in

## Database Schema Updates

### Flats Table
```sql
flats (
  -- ... existing fields ...
  construction_stage VARCHAR(50),
  construction_progress DECIMAL(5,2) DEFAULT 0,
  last_construction_update TIMESTAMP
)
```

### Demand Drafts Table (Already Exists)
```sql
demand_drafts (
  id UUID,
  flat_id UUID,
  customer_id UUID,
  booking_id UUID,
  milestone_id VARCHAR(200),
  amount DECIMAL(15,2),
  status VARCHAR(20),
  content TEXT,
  metadata JSONB,  -- Stores title, dueDate, milestone info
  generated_at TIMESTAMP,
  requires_review BOOLEAN,
  auto_generated BOOLEAN,
  flat_payment_plan_id UUID
)
```

### Flat Payment Plans Table (Already Exists)
```sql
flat_payment_plans (
  id UUID,
  flat_id UUID,
  customer_id UUID,
  booking_id UUID,
  total_amount DECIMAL(15,2),
  paid_amount DECIMAL(15,2),
  balance_amount DECIMAL(15,2),
  milestones JSONB,  -- Array of milestone objects
  status VARCHAR(20)
)
```

## Testing the Flow

### 1. Setup
- Create a property, tower, and flat
- Create a customer and booking
- Create a payment plan template with construction-linked milestones
- Link the flat to a payment plan

### 2. Log Progress
- Go to "Construction Progress (Simple)"
- Select the flat
- Log FOUNDATION phase at 100%
- Click Save

### 3. Verify Updates
- Check flats table → construction_stage should be "FOUNDATION"
- Check construction milestones page → milestone should move to "Ready to Trigger" or "Awaiting Payment"
- Check demand_drafts table → new draft should be created

### 4. Review & Send
- Go to Construction Milestones → Demand Drafts tab
- Review the auto-generated draft
- Edit if needed
- Export to HTML/PDF
- Approve and Send

## Migration Instructions

### 1. Run Database Migration
```bash
cd backend
psql -d eastern_estate_erp -f src/database/migrations/002_add_flat_construction_tracking.sql
```

### 2. Restart Backend
```bash
cd backend
npm run start:dev
```

### 3. Frontend Already Updated
- No frontend changes needed
- All features already connected

## Summary

✅ **Complete automation implemented**
✅ **Flat module tracks construction progress**
✅ **Payment plans linked to construction milestones**
✅ **Demand drafts auto-generated**
✅ **Edit and export functionality added**
✅ **All modules connected and working together**

The system now provides end-to-end automation from construction progress logging to demand draft generation, with full transparency and control at every step!
