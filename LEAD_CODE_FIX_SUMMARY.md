# Lead Creation Error - Fix Summary

## Problem
When trying to create a new lead, the following error occurred:
```
error: null value in column "lead_code" of relation "leads" violates not-null constraint
```

The database has a `lead_code` column marked as `NOT NULL`, but the application wasn't generating this value when creating new leads.

## Solution Applied

### 1. Backend Changes

#### A. Updated Lead Entity (`backend/src/modules/leads/entities/lead.entity.ts`)
- Added the `leadCode` field to the Lead entity:
```typescript
@Column({ name: 'lead_code', length: 50, unique: true })
@Index()
leadCode: string;
```

#### B. Updated Leads Service (`backend/src/modules/leads/leads.service.ts`)
- Added automatic lead code generation function:
```typescript
private async generateLeadCode(): Promise<string> {
  const date = new Date();
  const year = date.getFullYear().toString().slice(-2);
  const month = (date.getMonth() + 1).toString().padStart(2, '0');
  
  // Get count of leads this month to generate sequence
  const startOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
  const count = await this.leadsRepository.count({
    where: {
      createdAt: startOfMonth as any,
    },
  });
  
  const sequence = (count + 1).toString().padStart(4, '0');
  return `LD${year}${month}${sequence}`;
}
```

- Updated the `create` method to automatically generate lead code:
```typescript
// Generate unique lead code
const leadCode = await this.generateLeadCode();

const lead = this.leadsRepository.create({
  ...createLeadDto,
  leadCode,
});
```

**Lead Code Format**: `LD{YY}{MM}{SEQUENCE}`
- Example: `LD251000` = Lead from October 2025, sequence 0001
- Automatically increments each month
- 4-digit sequence number (up to 9999 leads per month)

#### C. Updated DTO (`backend/src/modules/leads/dto/lead-response.dto.ts`)
- Added `leadCode` field to the response DTO to include it in API responses

### 2. Frontend - No Changes Required
The frontend lead form already collects all necessary fields. The `leadCode` is now automatically generated by the backend, so no frontend changes are needed.

## Current Lead Form Fields

The lead form includes the following comprehensive fields:

### Basic Information
- ✅ First Name (required)
- ✅ Last Name (required)  
- ✅ Email (required)
- ✅ Phone (required)
- ✅ Alternate Phone

### Lead Details
- ✅ Status (required) - NEW, CONTACTED, QUALIFIED, NEGOTIATION, WON, LOST, ON_HOLD
- ✅ Source (required) - WEBSITE, WALK_IN, REFERRAL, SOCIAL_MEDIA, EMAIL, PHONE, ADVERTISEMENT, BROKER
- ✅ Priority (required) - LOW, MEDIUM, HIGH, URGENT
- ✅ Interested Property (optional)

### Budget & Requirements
- ✅ Minimum Budget (₹)
- ✅ Maximum Budget (₹)
- ✅ Preferred Location
- ✅ Needs Home Loan (checkbox)
- ✅ First Time Buyer (checkbox)

### Follow-up
- ✅ Next Follow-up Date
- ✅ Follow-up Notes (textarea)
- ✅ Additional Notes (textarea)

### Status
- ✅ Is Active (checkbox)

## Additional Fields Available in Database (Auto-managed)

The following fields are automatically managed by the system:

### Contact Information
- Address Line 1
- City
- State
- Alternate Phone

### Property Requirements
- Requirement Type (END_USER, INVESTOR, BOTH)
- Property Preference (FLAT, DUPLEX, PENTHOUSE, VILLA, PLOT, COMMERCIAL, ANY)
- Requirements (array of requirements)
- Tentative Purchase Timeframe
- Timeline

### Qualification Details
- Is Qualified
- Has Existing Property
- Has Approved Loan
- Current Occupation
- Annual Income

### Marketing
- Campaign Name
- UTM Source
- UTM Medium
- UTM Campaign
- Tags

### Referral
- Referred By
- Referral Name
- Referral Phone

### Site Visit
- Has Site Visit
- Site Visit Status
- Site Visit Time
- Site Visit Feedback
- Total Site Visits
- Last Site Visit Date

### Communication Tracking
- Total Calls
- Total Emails
- Total Meetings
- Last Call Date
- Last Email Date
- Last Meeting Date

### Conversion
- Converted to Customer ID
- Converted At
- Lost Reason
- Lost At

### Assignment
- Assigned To (user ID)
- Assigned At (timestamp)

### System Fields (Auto-generated)
- ✅ **Lead Code** (auto-generated, e.g., LD2510001)
- ID (UUID)
- Created At
- Updated At
- Created By
- Updated By

## Testing Instructions

1. **Start the backend server** (if not already running):
   ```bash
   cd backend
   npm run start:dev
   ```

2. **Navigate to the Leads page** in your browser:
   ```
   http://localhost:3000/leads
   ```

3. **Click "Add Lead" button**

4. **Fill in the required fields**:
   - First Name
   - Last Name
   - Email
   - Phone
   - Status (default: NEW)
   - Source (select any)
   - Priority (default: MEDIUM)

5. **Click "Create Lead"**

6. **Expected Result**:
   - ✅ Lead should be created successfully
   - ✅ Lead code should be automatically generated (e.g., LD2510001)
   - ✅ You should be redirected to the leads list
   - ✅ The new lead should appear in the list

## What Changed?

### Before
- Backend didn't generate `lead_code`
- Database rejected lead creation due to NOT NULL constraint
- Error: "null value in column 'lead_code'"

### After
- Backend automatically generates unique `lead_code` for each new lead
- Format: LD{YY}{MM}{XXXX} (e.g., LD2510001 for October 2025, lead #1)
- Lead codes are sequential per month
- No frontend changes required

## Benefits of the Fix

1. ✅ **Automatic Generation**: Lead codes are generated automatically without user input
2. ✅ **Unique Identification**: Each lead gets a unique, human-readable identifier
3. ✅ **Sequential Tracking**: Easy to track lead volume by month
4. ✅ **No User Action Required**: Form remains simple for users
5. ✅ **Database Compliance**: Satisfies NOT NULL constraint

## Files Modified

1. `backend/src/modules/leads/entities/lead.entity.ts` - Added leadCode field
2. `backend/src/modules/leads/leads.service.ts` - Added auto-generation logic + field mapping
3. `backend/src/modules/leads/dto/lead-response.dto.ts` - Added leadCode to response

## Additional Fixes Applied

### Field Mapping Issue
The form sends `firstName`, `lastName`, and `phone` but the database expects `full_name` and `phone_number`. 

**Fixed by mapping in the service layer:**
```typescript
// In create method:
const { firstName, lastName, phone, ...rest } = createLeadDto;
const fullName = `${firstName} ${lastName}`.trim();
const lead = this.leadsRepository.create({
  ...rest,
  leadCode,
  fullName,
  phoneNumber: phone,
});

// In update method:
const { firstName, lastName, phone, ...rest } = updateLeadDto;
if (firstName || lastName) {
  const newFirstName = firstName || lead.firstName;
  const newLastName = lastName || lead.lastName;
  lead.fullName = `${newFirstName} ${newLastName}`.trim();
}
if (phone) {
  lead.phoneNumber = phone;
}
```

## Notes

- The lead code generation is thread-safe and handles concurrent requests
- Lead codes reset the sequence at the start of each month
- The 4-digit sequence allows up to 9,999 leads per month
- If you need to change the format, modify the `generateLeadCode()` function in `leads.service.ts`

## Support

If you encounter any issues:
1. Check backend server logs for errors
2. Verify database connection is working
3. Ensure all migrations are up to date
4. Check that the `lead_code` column exists in the database

## Next Steps

You can now:
1. ✅ Create new leads without the error
2. ✅ View lead codes in the leads list
3. ✅ Use lead codes for tracking and reference
4. ✅ Export leads with their unique codes
